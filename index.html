<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gold Trade Empire Simulation</title>
  <style>
    /* =========== Dark-theme base =========== */
    :root{
      --bg: #0b0f12;
      --card: #0f1620;
      --muted: #9aa5b1;
      --accent: #f6c85f; /* gold accent */
      --danger: #ff6b6b;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --shadow: 0 6px 24px rgba(0,0,0,0.6);
      --radius: 14px;
      font-family: "Inter", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(246,200,95,0.03), transparent),
                  linear-gradient(180deg,#071017 0%,var(--bg) 100%);
      color:#e6eef6;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* =========== Top navbar =========== */
    header{
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px 20px;
      backdrop-filter: blur(6px);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-bottom: 1px solid rgba(255,255,255,0.02);
      box-shadow: var(--shadow);
      position:sticky;
      top:0;
      z-index:50;
    }
    .nav-title{
      font-weight:700;
      font-size:20px;
      letter-spacing:0.6px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .nav-title .logo {
      width:34px; height:34px; border-radius:8px;
      background: linear-gradient(135deg,#1b2733 0%, #1d2b3a 100%);
      display:inline-grid; place-items:center;
      box-shadow: inset 0 -6px 10px rgba(0,0,0,0.5);
      border:1px solid rgba(255,255,255,0.02);
      font-weight:800; color:var(--accent);
    }

    /* =========== Main layout =========== */
    main{flex:1; display:flex; align-items:center; justify-content:center; padding:28px 20px;}
    .container{
      width:100%;
      max-width:1100px;
      display:grid;
      grid-template-columns: repeat(2,1fr);
      gap:20px;
      align-items:start;
    }
    @media (max-width:880px){
      .container{grid-template-columns:1fr; padding-bottom:30px}
    }

    .card{
      background: linear-gradient(180deg,var(--card), #0b1116);
      border-radius: var(--radius);
      padding:18px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255,255,255,0.02);
    }
    .big{
      grid-column: 1 / -1;
      display:flex;
      gap:20px;
      flex-wrap:wrap;
      justify-content:space-between;
    }

    .stat{
      flex:1 1 220px;
      min-width:220px;
      padding:18px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      display:flex; flex-direction:column; gap:8px;
    }
    .stat h3{margin:0; font-size:13px; color:var(--muted); text-transform:uppercase; letter-spacing:0.9px}
    .stat .value{font-size:28px; font-weight:700; margin-top:4px}
    .stat .sub{font-size:12px; color:var(--muted)}

    /* Buy / Sell buttons */
    .actions{
      display:flex; gap:12px; align-items:center; justify-content:center;
    }
    .btn{
      padding:12px 18px;
      border-radius:10px;
      border:0; cursor:pointer; font-weight:700;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      color:var(--accent);
      box-shadow: 0 6px 18px rgba(0,0,0,0.6);
    }
    .btn.primary{
      background: linear-gradient(90deg, rgba(246,200,95,0.14), rgba(246,200,95,0.06));
      color:#081015;
      border: 1px solid rgba(246,200,95,0.16);
    }
    .btn.ghost{
      background:transparent; color:var(--muted); border:1px dashed rgba(255,255,255,0.03);
    }
    .btn:disabled{opacity:0.45; cursor:not-allowed}

    /* Footer */
    footer{padding:16px 20px; text-align:center; color:var(--muted); font-size:13px; border-top:1px solid rgba(255,255,255,0.02); background:var(--glass-2)}

    /* Modal */
    .modal-backdrop{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:120;
      background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.7));
    }
    .modal{
      width:100%; max-width:520px; padding:18px; border-radius:14px; background:linear-gradient(180deg,#0e1418,#0b1014);
      border:1px solid rgba(255,255,255,0.03);
    }
    .modal h2{margin:0 0 6px 0}
    .row{display:flex; gap:10px; margin-top:12px}
    .row .col{flex:1}
    .input{
      background: rgba(255,255,255,0.01);
      border: 1px solid rgba(255,255,255,0.03);
      padding:10px 12px; border-radius:8px; color: #dfeaf6; width:100%;
    }
    .muted{color:var(--muted); font-size:13px}
    .hint{font-size:12px;color:var(--muted); margin-top:8px}

    .top-row{
      display:flex; gap:12px; align-items:center; justify-content:space-between; width:100%;
    }
    .price-tag{
      display:flex; gap:10px; align-items:center;
    }
    .price-bubble{
      background:rgba(255,255,255,0.02); padding:8px 12px; border-radius:999px; font-weight:700; color:var(--accent)
    }

    /* small details */
    .small-muted{font-size:12px;color:var(--muted)}
    .center{text-align:center}
    .right{text-align:right}
  </style>
</head>
<body>
  <header>
    <div class="nav-title" role="banner">
      <div class="logo">G</div>
      <div>Gold Trade Empire Simulation</div>
    </div>
  </header>

  <main>
    <div class="container">
      <div class="card big">
        <div class="top-row" style="width:100%">
          <div style="display:flex;flex-direction:column">
            <div class="small-muted">Real-time Gold Price (USD / oz)</div>
            <div style="display:flex;gap:12px;align-items:baseline">
              <div class="price-bubble" id="priceBubble">--</div>
              <div class="small-muted" id="priceTime">last update: --</div>
            </div>
          </div>
          <div class="price-tag">
            <div class="small-muted">Account Status</div>
            <div style="width:6px"></div>
            <div class="small-muted" id="netWorth">Net Worth: --</div>
          </div>
        </div>
      </div>

      <div class="card stat">
        <h3>Money Balance</h3>
        <div class="value" id="moneyBalance">$0.00</div>
        <div class="sub">USD available to purchase gold</div>
      </div>

      <div class="card stat">
        <h3>Gold Balance</h3>
        <div class="value" id="goldBalance">0.000 oz</div>
        <div class="sub">Troy ounces (oz)</div>
      </div>

      <div class="card stat">
        <h3>Buy</h3>
        <div class="value" id="buyPreview">Min: 0.1 oz</div>
        <div class="sub">Buy gold using USD at latest price</div>
        <div style="margin-top:12px" class="actions">
          <button class="btn primary" id="buyBtn">Buy Gold</button>
        </div>
      </div>

      <div class="card stat">
        <h3>Sell</h3>
        <div class="value" id="sellPreview">Sale fee: 5%</div>
        <div class="sub">Sell your gold; 5% cut on receivable</div>
        <div style="margin-top:12px" class="actions">
          <button class="btn primary" id="sellBtn">Sell Gold</button>
        </div>
      </div>

      <!-- Below area: logs or hints -->
      <div class="card" style="grid-column:1 / -1;">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
          <div class="muted">Game requires internet to fetch latest metal price for buy/sell and on refresh.</div>
          <div class="small-muted">Tip: Minimum purchase 0.1 oz | Sell fee 5%</div>
        </div>
      </div>
    </div>
  </main>

  <footer>
    email me to buy the game: <a href="mailto:niaz.al.motin@gmail.com" style="color:var(--accent)">niaz.al.motin@gmail.com</a>
  </footer>

  <!-- Modal UI -->
  <div class="modal-backdrop" id="modalBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h2 id="modalTitle">Modal</h2>
        <button class="btn ghost" id="closeModal">Close</button>
      </div>

      <div id="modalBody">
        <!-- dynamic contents -->
      </div>

      <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:14px">
        <button class="btn ghost" id="modalCancel">Cancel</button>
        <button class="btn primary" id="modalConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    /*************************************************************************
     * Gold Trade Empire Simulation
     * - Uses Metals-API to fetch XAU price in USD per troy ounce.
     * - Local persistence via localStorage.
     * - Requires internet to fetch price on start and on every buy/sell action.
     *
     * IMPORTANT:
     * - Insert your Metals-API key below.
     * - If you encounter CORS, route requests through a server-side proxy:
     *    e.g. YOUR_PROXY_ENDPOINT = '/proxy?target=https://metals-api.com/api/latest?access_key=KEY...'
     *************************************************************************/

    // ======= Configuration =======
    const CONFIG = {
      // Put your Metals-API key here:
      METALS_API_KEY: 'YOUR_METALS_API_KEY',

      // Metals-API latest endpoint pattern:
      // Recommended: use a server-side proxy in production to protect the key.
      // Direct browser URL (may be blocked by CORS for some plans):
      METALS_API_URL: (key) =>
        `https://metals-api.com/api/latest?access_key=${encodeURIComponent(key)}&base=USD&symbols=XAU`,

      // If using a proxy to protect your key, set PROXY_URL to something like:
      // PROXY_URL: (key) => `/proxy?url=${encodeURIComponent('https://metals-api.com/api/latest?access_key=' + key + '&base=USD&symbols=XAU')}`
      PROXY_URL: null,

      POLL_INTERVAL_MS: 30000, // auto-refresh price every 30s
      MIN_PURCHASE_OZ: 0.1,
      SELL_FEE_RATE: 0.05,
      STORAGE_KEY: 'gold_trade_empire_v1'
    };

    // ======= State & Persistence =======
    const defaults = {
      money: 10000.00,   // USD
      gold: 0.0,         // oz
      lastPrice: null,
      lastPriceTime: null
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(CONFIG.STORAGE_KEY);
        if (!raw) return {...defaults};
        const parsed = JSON.parse(raw);
        return {
          money: Number(parsed.money ?? defaults.money),
          gold: Number(parsed.gold ?? defaults.gold),
          lastPrice: parsed.lastPrice ?? null,
          lastPriceTime: parsed.lastPriceTime ?? null
        };
      } catch (e) {
        console.error('loadState error', e);
        return {...defaults};
      }
    }

    function saveState(state) {
      localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify({
        money: Number(state.money),
        gold: Number(state.gold),
        lastPrice: state.lastPrice,
        lastPriceTime: state.lastPriceTime
      }));
    }

    let state = loadState();

    // ======= DOM refs =======
    const moneyEl = document.getElementById('moneyBalance');
    const goldEl = document.getElementById('goldBalance');
    const priceBubble = document.getElementById('priceBubble');
    const priceTime = document.getElementById('priceTime');
    const buyBtn = document.getElementById('buyBtn');
    const sellBtn = document.getElementById('sellBtn');
    const netWorthEl = document.getElementById('netWorth');

    // Modal refs
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalConfirm = document.getElementById('modalConfirm');
    const modalCancel = document.getElementById('modalCancel');
    const closeModalBtn = document.getElementById('closeModal');

    // ======= Helpers =======
    function formatUSD(num) {
      return '$' + Number(num).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    function formatOZ(num) {
      return Number(num).toLocaleString(undefined, {minimumFractionDigits:3, maximumFractionDigits:6}) + ' oz';
    }
    function nowISO(){ return (new Date()).toLocaleString(); }

    function updateUI() {
      moneyEl.textContent = formatUSD(state.money);
      goldEl.textContent = formatOZ(state.gold);
      if (state.lastPrice) {
        priceBubble.textContent = formatUSD(state.lastPrice);
        priceTime.textContent = 'last update: ' + state.lastPriceTime;
        const net = state.money + state.gold * state.lastPrice;
        netWorthEl.textContent = 'Net Worth: ' + formatUSD(net);
      } else {
        priceBubble.textContent = '--';
        priceTime.textContent = 'last update: --';
        netWorthEl.textContent = 'Net Worth: --';
      }
      // Enable/disable buy/sell depending on price availability & balances
      const online = !!state.lastPrice;
      buyBtn.disabled = !online;
      sellBtn.disabled = !online || state.gold <= 0;
    }

    // ======= API: get latest gold price (USD per oz) =======
    async function fetchLatestPrice() {
      // Build URL: use proxy if configured (safer), else direct URL
      const key = CONFIG.METALS_API_KEY;
      if (!key || key === 'YOUR_METALS_API_KEY') {
        throw new Error('Please set your Metals-API key in the CONFIG.METALS_API_KEY variable.');
      }
      let url;
      if (CONFIG.PROXY_URL) {
        url = CONFIG.PROXY_URL(key);
      } else {
        url = CONFIG.METALS_API_URL(key);
      }

      const resp = await fetch(url);
      if (!resp.ok) {
        throw new Error('Price fetch failed: ' + resp.status);
      }
      const json = await resp.json();
      // Metals-API returns rates as rates.XAU = XAU per USD (if base=USD)
      // Example: { rates: { XAU: 0.000559 } } => USD per XAU = 1 / 0.000559
      if (!json || !json.rates || typeof json.rates.XAU === 'undefined') {
        throw new Error('Unexpected response from price API');
      }
      const rateXAU = Number(json.rates.XAU);
      if (rateXAU === 0) throw new Error('Invalid rate from API');

      const usdPerOz = 1 / rateXAU;
      // Save state
      state.lastPrice = Number(usdPerOz);
      state.lastPriceTime = nowISO();
      saveState(state);
      updateUI();
      return state.lastPrice;
    }

    // ======= Modal utilities =======
    function openModal({title, bodyHtml, confirmText='Confirm', onConfirm}) {
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHtml;
      modalConfirm.textContent = confirmText;
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      // detach previous
      modalConfirm.onclick = async () => {
        try {
          modalConfirm.disabled = true;
          await onConfirm();
          modalConfirm.disabled = false;
          closeModal();
        } catch (err) {
          modalConfirm.disabled = false;
          alert(err.message || 'Operation failed');
        }
      };
      modalCancel.onclick = closeModal;
      closeModalBtn.onclick = closeModal;
    }
    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
      modalConfirm.onclick = null;
      modalCancel.onclick = null;
    }

    // ======= Buy Flow =======
    buyBtn.addEventListener('click', async () => {
      // require latest price first
      try {
        await fetchLatestPrice();
      } catch (err) {
        alert('Cannot fetch latest price. Check your internet/API key/CORS. ' + err.message);
        return;
      }

      const html = `
        <div class="muted">Available USD: <strong>${formatUSD(state.money)}</strong></div>
        <div class="muted" style="margin-top:8px">Gold price now: <strong>${formatUSD(state.lastPrice)}</strong> per oz</div>
        <div class="row" style="margin-top:12px">
          <div class="col">
            <label class="small-muted">Amount (oz)</label>
            <input id="buyAmount" class="input" type="number" min="${CONFIG.MIN_PURCHASE_OZ}" step="0.001" value="${CONFIG.MIN_PURCHASE_OZ}">
            <div class="hint">Minimum ${CONFIG.MIN_PURCHASE_OZ} oz. Max you can buy: ${(state.money / state.lastPrice).toFixed(6)} oz</div>
          </div>
          <div class="col">
            <label class="small-muted">Total Cost (USD)</label>
            <input id="buyTotal" class="input" type="text" readonly value="${formatUSD((CONFIG.MIN_PURCHASE_OZ * state.lastPrice).toFixed(2))}">
          </div>
        </div>
      `;

      openModal({
        title: 'Buy Gold',
        bodyHtml: html,
        confirmText: 'Buy',
        onConfirm: async () => {
          const amt = parseFloat(document.getElementById('buyAmount').value);
          if (isNaN(amt) || amt < CONFIG.MIN_PURCHASE_OZ) throw new Error('Minimum purchase is ' + CONFIG.MIN_PURCHASE_OZ + ' oz');
          // Re-fetch price to ensure freshest value
          await fetchLatestPrice();
          const cost = Number((amt * state.lastPrice).toFixed(6));
          if (cost > state.money + 1e-8) throw new Error('Insufficient USD balance to buy ' + amt + ' oz');
          // commit
          state.money = Number((state.money - cost).toFixed(6));
          state.gold = Number((state.gold + amt).toFixed(6));
          saveState(state);
          updateUI();
          alert('Purchase successful: Bought ' + amt + ' oz for ' + formatUSD(cost));
        }
      });

      // wire up live total calculation
      setTimeout(()=>{
        const buyAmount = document.getElementById('buyAmount');
        const buyTotal = document.getElementById('buyTotal');
        if (!buyAmount) return;
        function refreshTotal(){
          const a = parseFloat(buyAmount.value || 0);
          const tot = (a * state.lastPrice) || 0;
          buyTotal.value = formatUSD(tot.toFixed(2));
        }
        buyAmount.addEventListener('input', refreshTotal);
        refreshTotal();
      },50);
    });

    // ======= Sell Flow =======
    sellBtn.addEventListener('click', async () => {
      // require latest price first
      try {
        await fetchLatestPrice();
      } catch (err) {
        alert('Cannot fetch latest price. Check your internet/API key/CORS. ' + err.message);
        return;
      }

      const html = `
        <div class="muted">Available Gold: <strong>${state.gold.toFixed(6)} oz</strong></div>
        <div class="muted" style="margin-top:8px">Gold price now: <strong>${formatUSD(state.lastPrice)}</strong> per oz</div>
        <div class="row" style="margin-top:12px">
          <div class="col">
            <label class="small-muted">Amount to sell (oz)</label>
            <input id="sellAmount" class="input" type="number" min="0.001" step="0.001" value="${Math.min(1, state.gold).toFixed(3)}">
            <div class="hint">You own ${state.gold.toFixed(6)} oz. Selling will incur ${CONFIG.SELL_FEE_RATE*100}% fee.</div>
          </div>
          <div class="col">
            <label class="small-muted">Estimated Receive (USD)</label>
            <input id="sellTotal" class="input" type="text" readonly value="${formatUSD(0)}">
          </div>
        </div>
      `;

      openModal({
        title: 'Sell Gold',
        bodyHtml: html,
        confirmText: 'Sell',
        onConfirm: async () => {
          const amt = parseFloat(document.getElementById('sellAmount').value);
          if (isNaN(amt) || amt <= 0) throw new Error('Invalid amount to sell');
          if (amt > state.gold + 1e-8) throw new Error('You do not own that much gold');
          // Re-fetch latest price
          await fetchLatestPrice();
          const gross = amt * state.lastPrice;
          const fee = gross * CONFIG.SELL_FEE_RATE;
          const net = gross - fee;
          // commit
          state.gold = Number((state.gold - amt).toFixed(6));
          state.money = Number((state.money + net).toFixed(6));
          saveState(state);
          updateUI();
          alert('Sell successful: Sold ' + amt + ' oz. Receivable ' + formatUSD(net) + ' (fee ' + formatUSD(fee) + ')');
        }
      });

      // wire up live calculation
      setTimeout(()=>{
        const sellAmount = document.getElementById('sellAmount');
        const sellTotal = document.getElementById('sellTotal');
        if (!sellAmount) return;
        function refreshTotal(){
          const a = Number(sellAmount.value || 0);
          const gross = a * state.lastPrice;
          const fee = gross * CONFIG.SELL_FEE_RATE;
          const net = gross - fee;
          sellTotal.value = formatUSD(net.toFixed(2));
        }
        sellAmount.addEventListener('input', refreshTotal);
        refreshTotal();
      },50);
    });

    // ======= Startup & Polling =======
    async function init() {
      updateUI();
      // Attempt initial fetch. If fails, UI shows price as unavailable and buy/sell disabled.
      try {
        await fetchLatestPrice();
      } catch (err) {
        console.warn('Initial price fetch failed:', err.message);
        // If previously stored price exists, show it. Otherwise show offline.
        if (!state.lastPrice) {
          priceBubble.textContent = 'offline';
          priceTime.textContent = 'Cannot fetch price. Check API key / internet / CORS.';
        }
      }
      updateUI();

      // Polling loop
      setInterval(async () => {
        try {
          await fetchLatestPrice();
        } catch (err) {
          console.warn('Price poll failed:', err.message);
        }
      }, CONFIG.POLL_INTERVAL_MS);
    }

    // run
    init().catch(console.error);

    // ======= Accessibility: close modal by Esc =======
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // small UX: warn user before leaving if there's an active modal
    window.addEventListener('beforeunload', (e) => {
      // allow unload, but no extra prompt necessary for this game
    });
  </script>
</body>
</html>
